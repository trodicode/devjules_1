<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V.1.02 - API Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1A1A2E;
            color: #E0E0E0;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #16213E;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #00F0F0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: rgba(57, 255, 20, 0.1);
            border: 1px solid #39FF14;
            color: #39FF14;
        }
        .error {
            background: rgba(249, 0, 249, 0.1);
            border: 1px solid #F900F9;
            color: #F900F9;
        }
        .warning {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #FFA500;
            color: #FFA500;
        }
        button {
            background: #00F0F0;
            color: #1A1A2E;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00D0D0;
        }
        #log {
            background: #0F0F0F;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>üß™ Test de connexion API Baserow</h1>
            <span style="background: linear-gradient(45deg, #F900F9, #00F0F0); color: #1A1A2E; padding: 6px 12px; border-radius: 15px; font-weight: bold; font-size: 14px;">V.1.02</span>
        </div>

        <!-- Environment Detection Banner -->
        <div id="environmentBanner" style="background: linear-gradient(45deg, #F900F9, #00F0F0); color: #1A1A2E; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold;">
            üîç Environnement : <span id="environmentType">D√©tection...</span>
        </div>

        <div>
            <button onclick="testConfiguration()">1Ô∏è‚É£ Tester la configuration</button>
            <button onclick="testBasicConnection()">2Ô∏è‚É£ Tester la connexion basique</button>
            <button onclick="testUsersTable()">3Ô∏è‚É£ Tester l'acc√®s √† la table utilisateurs</button>
            <button onclick="testTicketsTable()">4Ô∏è‚É£ Tester l'acc√®s √† la table tickets</button>
            <button onclick="inspectTicketFields()">5Ô∏è‚É£ Inspecter les champs d'un ticket</button>
            <button onclick="inspectUsersTable()">6Ô∏è‚É£ Inspecter les utilisateurs</button>
            <button onclick="testUserLogin()">7Ô∏è‚É£ Tester la connexion utilisateur</button>
            <button onclick="clearLog()">üóëÔ∏è Effacer les logs</button>
        </div>

        <!-- Test User Login Form -->
        <div style="margin: 20px 0; padding: 15px; background: rgba(0, 240, 240, 0.1); border: 1px solid #00F0F0; border-radius: 5px;">
            <h3>üîê Test de connexion utilisateur</h3>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <input type="email" id="testEmail" placeholder="Email" style="flex: 1; padding: 8px; background: #1A1A2E; color: #E0E0E0; border: 1px solid #00F0F0;">
                <input type="password" id="testPassword" placeholder="Mot de passe" style="flex: 1; padding: 8px; background: #1A1A2E; color: #E0E0E0; border: 1px solid #00F0F0;">
                <button onclick="testUserLogin()" style="padding: 8px 15px; background: #00F0F0; color: #1A1A2E; border: none; border-radius: 3px; cursor: pointer;">Tester</button>
            </div>
            <div id="loginTestResult" style="margin-top: 10px; display: none;"></div>
        </div>

        <div id="log"></div>

        <div id="results">
            <div id="configResult" class="test-result" style="display: none;"></div>
            <div id="connectionResult" class="test-result" style="display: none;"></div>
            <div id="usersResult" class="test-result" style="display: none;"></div>
            <div id="ticketsResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script>window.BASEROW_API_TOKEN = "YOUR_API_TOKEN_HERE";</script>
    <script src="js/config.js"></script>
    <script src="js/baserow-api.js"></script>
    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#F900F9' : type === 'success' ? '#39FF14' : '#00F0F0';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `test-result ${type}`;
            element.style.display = 'block';
        }

        function testConfiguration() {
            log('üîç Test de la configuration...', 'info');

            const results = [];

            // Test API Token
            if (typeof BASEROW_API_TOKEN !== 'undefined') {
                if (BASEROW_API_TOKEN === 'YOUR_API_TOKEN_HERE' || BASEROW_API_TOKEN.startsWith('DidwqyN')) {
                    results.push('‚úÖ API Token: Configur√©');
                    log('API Token trouv√© et configur√©', 'success');
                } else {
                    results.push('‚úÖ API Token: Configur√©');
                    log('API Token trouv√© et configur√©', 'success');
                }
            } else {
                results.push('‚ùå API Token: Non charg√©');
                log('Constante BASEROW_API_TOKEN non trouv√©e', 'error');
            }

            // Test Database ID
            if (typeof BASEROW_DATABASE_ID !== 'undefined') {
                if (BASEROW_DATABASE_ID === 'YOUR_DATABASE_ID' || BASEROW_DATABASE_ID === '305770') {
                    results.push('‚úÖ Database ID: Configur√©');
                    log('Database ID trouv√© et configur√©', 'success');
                } else {
                    results.push('‚úÖ Database ID: Configur√©');
                    log('Database ID trouv√© et configur√©', 'success');
                }
            } else {
                results.push('‚ùå Database ID: Non charg√©');
                log('Constante BASEROW_DATABASE_ID non trouv√©e', 'error');
            }

            // Test Table IDs
            if (typeof BASEROW_USERS_TABLE_ID !== 'undefined') {
                if (BASEROW_USERS_TABLE_ID === 'YOUR_USERS_TABLE_ID' || BASEROW_USERS_TABLE_ID === '708905') {
                    results.push('‚úÖ Users Table ID: Configur√©');
                } else {
                    results.push('‚úÖ Users Table ID: Configur√©');
                }
            } else {
                results.push('‚ùå Users Table ID: Non charg√©');
            }

            if (typeof BASEROW_TICKETS_TABLE_ID !== 'undefined') {
                if (BASEROW_TICKETS_TABLE_ID === 'YOUR_TICKETS_TABLE_ID' || BASEROW_TICKETS_TABLE_ID === '708904') {
                    results.push('‚úÖ Tickets Table ID: Configur√©');
                } else {
                    results.push('‚úÖ Tickets Table ID: Configur√©');
                }
            } else {
                results.push('‚ùå Tickets Table ID: Non charg√©');
            }

            // Test API Functions
            if (typeof getUserByEmail === 'function') {
                results.push('‚úÖ Fonction getUserByEmail: Disponible');
            } else {
                results.push('‚ùå Fonction getUserByEmail: Non disponible');
            }

            if (typeof COLUMN_NAMES !== 'undefined') {
                results.push('‚úÖ COLUMN_NAMES: Charg√©');
            } else {
                results.push('‚ùå COLUMN_NAMES: Non charg√©');
            }

            const configResult = results.join('\n');
            showResult('configResult', configResult, results.some(r => r.includes('‚ùå')) ? 'error' : 'success');
            log(`Test de configuration termin√©. R√©sultats: ${results.filter(r => r.includes('‚úÖ')).length}/${results.length} √©l√©ments OK`);
        }

        async function testBasicConnection() {
            log('üîç Test de connexion basique √† Baserow...', 'info');

            if (BASEROW_API_TOKEN === 'YOUR_BASEROW_API_TOKEN_HERE') {
                showResult('connectionResult', '‚ùå Impossible de tester: API Token non configur√©', 'error');
                log('Test annul√©: API Token non configur√©', 'error');
                return;
            }

            try {
                log(`üîë Utilisation du token: ${BASEROW_API_TOKEN.substring(0, 10)}...`, 'info');

                // Test simple API call to check if Baserow is reachable
                const response = await fetch('https://api.baserow.io/api/user/', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`üì° R√©ponse HTTP: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                log(`üìã Headers de r√©ponse:`, 'info');
                response.headers.forEach((value, key) => {
                    log(`  ${key}: ${value}`, 'info');
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('connectionResult', `‚úÖ Connexion r√©ussie! Utilisateur: ${data.first_name} ${data.last_name}`, 'success');
                    log('Connexion √† l\'API Baserow √©tablie avec succ√®s', 'success');
                } else {
                    let errorDetails = '';
                    try {
                        const errorData = await response.json();
                        errorDetails = JSON.stringify(errorData, null, 2);
                    } catch {
                        errorDetails = await response.text() || 'No error details';
                    }
                    showResult('connectionResult', `‚ùå Erreur API (${response.status}): ${errorDetails}`, 'error');
                    log(`Erreur API d√©taill√©e: ${errorDetails}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                log(`üîç Type d'erreur: ${error.name}`, 'error');

                // Check if it's a CORS error
                if (error.message.includes('CORS') || error.message.includes('Access-Control')) {
                    showResult('connectionResult', `üö´ Erreur CORS: ${error.message}\n\nüí° Solution: H√©bergez le fichier sur un serveur web (localhost ou serveur distant)`, 'error');
                    log('Probl√®me CORS d√©tect√© - requ√™te bloqu√©e par le navigateur', 'error');
                } else {
                    showResult('connectionResult', `‚ùå Erreur de connexion: ${error.message}`, 'error');
                }
            }
        }

        async function testUsersTable() {
            log('üîç Test d\'acc√®s √† la table utilisateurs...', 'info');

            if (BASEROW_USERS_TABLE_ID === 'YOUR_USERS_TABLE_ID' || BASEROW_USERS_TABLE_ID === '708905') {
                log('Test de la table utilisateurs avec ID configur√©', 'success');
            } else {
                log('Test de la table utilisateurs avec ID personnalis√©', 'success');
            }

            try {
                const response = await fetch(`https://api.baserow.io/api/database/rows/table/${BASEROW_USERS_TABLE_ID}/?user_field_names=true`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`R√©ponse HTTP pour table users: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    showResult('usersResult', `‚úÖ Acc√®s r√©ussi! ${data.results?.length || 0} utilisateurs trouv√©s`, 'success');
                    log(`${data.results?.length || 0} utilisateurs trouv√©s dans la table`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showResult('usersResult', `‚ùå Erreur d'acc√®s: ${errorData.detail || response.statusText}`, 'error');
                    log(`Erreur d'acc√®s √† la table users: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                showResult('usersResult', `‚ùå Erreur de connexion: ${error.message}`, 'error');
                log(`Erreur de connexion √† la table users: ${error.message}`, 'error');
            }
        }

        async function testTicketsTable() {
            log('üîç Test d\'acc√®s √† la table tickets...', 'info');

            if (BASEROW_TICKETS_TABLE_ID === 'YOUR_TICKETS_TABLE_ID' || BASEROW_TICKETS_TABLE_ID === '708904') {
                log('Test de la table tickets avec ID configur√©', 'success');
            } else {
                log('Test de la table tickets avec ID personnalis√©', 'success');
            }

            try {
                const response = await fetch(`https://api.baserow.io/api/database/rows/table/${BASEROW_TICKETS_TABLE_ID}/?user_field_names=true`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`R√©ponse HTTP pour table tickets: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    showResult('ticketsResult', `‚úÖ Acc√®s r√©ussi! ${data.results?.length || 0} tickets trouv√©s`, 'success');
                    log(`${data.results?.length || 0} tickets trouv√©s dans la table`, 'success');
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showResult('ticketsResult', `‚ùå Erreur d'acc√®s: ${errorData.detail || response.statusText}`, 'error');
                    log(`Erreur d'acc√®s √† la table tickets: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                showResult('ticketsResult', `‚ùå Erreur de connexion: ${error.message}`, 'error');
                log(`Erreur de connexion √† la table tickets: ${error.message}`, 'error');
            }
        }

        async function inspectTicketFields() {
            log('üîç Inspection des champs d\'un ticket...', 'info');

            if (BASEROW_TICKETS_TABLE_ID === 'YOUR_TICKETS_TABLE_ID' || BASEROW_TICKETS_TABLE_ID === '708904') {
                log('Test d\'inspection avec ID de table configur√©', 'success');
            } else {
                log('Test d\'inspection avec ID de table personnalis√©', 'success');
            }

            try {
                const response = await fetch(`https://api.baserow.io/api/database/rows/table/${BASEROW_TICKETS_TABLE_ID}/?user_field_names=true`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`R√©ponse HTTP pour inspection: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        const firstTicket = data.results[0];
                        log('üîç Champs disponibles dans le premier ticket:', 'success');

                        // Show all field names
                        Object.keys(firstTicket).forEach(key => {
                            const value = firstTicket[key];
                            const type = typeof value;
                            log(`  üìã ${key}: ${type} = ${value}`, 'info');
                        });

                        showResult('ticketsResult', `‚úÖ Inspection r√©ussie! ${Object.keys(firstTicket).length} champs trouv√©s. Voir les logs pour les d√©tails.`, 'success');
                    } else {
                        showResult('ticketsResult', '‚ö†Ô∏è Aucun ticket trouv√© pour l\'inspection', 'warning');
                        log('Aucun ticket trouv√© dans la table pour l\'inspection', 'warning');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showResult('ticketsResult', `‚ùå Erreur d'inspection: ${errorData.detail || response.statusText}`, 'error');
                    log(`Erreur d'inspection: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                showResult('ticketsResult', `‚ùå Erreur d'inspection: ${error.message}`, 'error');
                log(`Erreur d'inspection: ${error.message}`, 'error');
            }
        }

        async function inspectUsersTable() {
            log('üîç Inspection de la table utilisateurs...', 'info');

            if (BASEROW_USERS_TABLE_ID === 'YOUR_USERS_TABLE_ID' || BASEROW_USERS_TABLE_ID === '708905') {
                log('Test d\'inspection users avec ID configur√©', 'success');
            } else {
                log('Test d\'inspection users avec ID personnalis√©', 'success');
            }

            try {
                const response = await fetch(`https://api.baserow.io/api/database/rows/table/${BASEROW_USERS_TABLE_ID}/?user_field_names=true`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`R√©ponse HTTP pour inspection users: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();

                    if (data.results && data.results.length > 0) {
                        log('üîç Utilisateurs trouv√©s:', 'success');
                        data.results.forEach((user, index) => {
                            log(`üë§ Utilisateur ${index + 1}:`, 'info');
                            Object.keys(user).forEach(key => {
                                const value = user[key];
                                const type = typeof value;
                                log(`  üìã ${key}: ${type} = ${value}`, 'info');
                            });
                        });

                        showResult('usersResult', `‚úÖ Inspection r√©ussie! ${data.results.length} utilisateurs trouv√©s. Voir les logs pour les d√©tails.`, 'success');
                    } else {
                        showResult('usersResult', '‚ö†Ô∏è Aucun utilisateur trouv√©', 'warning');
                        log('Aucun utilisateur trouv√© dans la table', 'warning');
                    }
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showResult('usersResult', `‚ùå Erreur d'inspection: ${errorData.detail || response.statusText}`, 'error');
                    log(`Erreur d'inspection users: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (error) {
                showResult('usersResult', `‚ùå Erreur d'inspection: ${error.message}`, 'error');
                log(`Erreur d'inspection users: ${error.message}`, 'error');
            }
        }

        async function testUserLogin() {
            const emailInput = document.getElementById('testEmail');
            const passwordInput = document.getElementById('testPassword');
            const resultDiv = document.getElementById('loginTestResult');

            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value.trim() : '';

            console.log('üîç Debug Test Login - Email input:', emailInput);
            console.log('üîç Debug Test Login - Password input:', passwordInput);
            console.log('üîç Debug Test Login - Email value:', email);
            console.log('üîç Debug Test Login - Password value:', password);

            if (!email || !password) {
                resultDiv.textContent = '‚ùå Email et mot de passe requis';
                resultDiv.className = 'test-result error';
                resultDiv.style.display = 'block';
                return;
            }

            log(`üîê Test de connexion pour: ${email}`, 'info');
            resultDiv.style.display = 'none';

            try {
                // Use the same logic as the real login system
                const userRecord = await window.getUserByEmail(email);
                console.log('üîç Debug Test Login - User record:', userRecord);

                if (userRecord && userRecord.fields) {
                    const storedPassword = userRecord.fields[window.COLUMN_NAMES.USER_PASSWORD];
                    const userRoleObject = userRecord.fields[window.COLUMN_NAMES.USER_ROLE];

                    // Handle both object and string formats for user role
                    let userRole;
                    if (userRoleObject && typeof userRoleObject === 'object' && userRoleObject.value) {
                        userRole = userRoleObject.value;
                    } else if (typeof userRoleObject === 'string') {
                        userRole = userRoleObject;
                    } else {
                        userRole = null;
                    }

                    console.log('üîç Debug Test Login - Stored password:', storedPassword);
                    console.log('üîç Debug Test Login - User role:', userRole);

                    if (storedPassword === password) {
                        resultDiv.innerHTML = `
                            ‚úÖ Connexion r√©ussie!<br>
                            üë§ Email: ${email}<br>
                            üè∑Ô∏è R√¥le: ${userRole}<br>
                            üîÄ Redirection: ${userRole === 'Administrateur' ? 'admin.html' : 'index.html'}
                        `;
                        resultDiv.className = 'test-result success';
                        log(`‚úÖ Connexion r√©ussie pour ${email} avec r√¥le ${userRole}`, 'success');
                    } else {
                        resultDiv.textContent = '‚ùå Mot de passe incorrect';
                        resultDiv.className = 'test-result error';
                        log(`‚ùå Mot de passe incorrect pour ${email}`, 'error');
                    }
                } else {
                    resultDiv.textContent = '‚ùå Utilisateur non trouv√©';
                    resultDiv.className = 'test-result error';
                    log(`‚ùå Utilisateur ${email} non trouv√©`, 'error');
                }
            } catch (error) {
                resultDiv.textContent = `‚ùå Erreur: ${error.message}`;
                resultDiv.className = 'test-result error';
                log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
            }

            resultDiv.style.display = 'block';
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Logs effac√©s', 'info');
        }

        // Environment detection function
        function detectEnvironment() {
            const hostname = window.location.hostname;
            const banner = document.getElementById('environmentBanner');
            const envType = document.getElementById('environmentType');

            if (hostname.includes('netlify')) {
                envType.textContent = 'Netlify üåê';
                banner.style.background = 'linear-gradient(45deg, #F900F9, #00F0F0)';
                banner.innerHTML += ' <span style="font-size: 12px; opacity: 0.8;">(Production)</span>';
                log('üåê Environnement Netlify d√©tect√©', 'info');
            } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
                envType.textContent = 'Localhost üíª';
                banner.style.background = 'linear-gradient(45deg, #39FF14, #00F0F0)';
                banner.innerHTML += ' <span style="font-size: 12px; opacity: 0.8;">(D√©veloppement)</span>';
                log('üíª Environnement local d√©tect√©', 'success');
            } else {
                envType.textContent = 'Inconnu ‚ùì';
                banner.style.background = 'linear-gradient(45deg, #FFA500, #F900F9)';
                banner.innerHTML += ' <span style="font-size: 12px; opacity: 0.8;">(' + hostname + ')</span>';
                log('‚ùì Environnement inconnu d√©tect√©: ' + hostname, 'warning');
            }
        }

        // Auto-run configuration test on page load
        window.addEventListener('load', () => {
            detectEnvironment();
            log('üöÄ Page de test charg√©e. Cliquez sur les boutons pour commencer les tests.', 'info');
            setTimeout(testConfiguration, 500);
        });
    </script>
</body>
</html>
